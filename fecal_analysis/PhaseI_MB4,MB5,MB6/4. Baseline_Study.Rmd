---
title: "R Notebook"
output: word_document
editor_options: 
  chunk_output_type: console
---
#To Update
```{r}
project_name="Project_NP0084-MB4_5_pt6_2"
manifest_name="metadata_Summary_3.csv"
otu_name="otu_Summary_3.csv"
sample_depth= 20000
```

#Load required libraries
############### 
```{r}
library("biom")
library(data.table)
library(tm)
library(vegan)
library("biom")
library(tidyr)
library(ggplot2)
library(cowplot)
library(scales)
library(phyloseq)
library(qiime2R)
library(tibble)
library(gridExtra)
library(tidyverse)
```

#Analysis
###############
#1. Taxonomy Reference - Expected frequencies
```{r}
#Read in controls taxonomy file, grouped by Genus
control_expect <- read.table("T:\\DCEG\\CGF\\TechTransfer\\Microbiome\\Extraction\\Optimization\\Fecal\\Fresh Fecal Optimization_2017.08\\Phase I\\Controls\\Taxonomy\\Taxonomy_Genus_2019.txt",sep="\t",header=TRUE)
rownames(control_expect) <- unique(control_expect[,"Genus"])
```

#2. Load OTU and metadata tables
```{r}
#Create location link
project_location= paste("T:\\DCEG\\Projects\\Microbiome\\CGR_MB\\MicroBiome\\",project_name,sep="")

#Read in database with variable information
metadata_baseline <- read.table(paste(project_location,"\\Output\\R\\OTUs\\",manifest_name,sep=""),sep=",",header= TRUE)
rownames(metadata_baseline)<-metadata_baseline$X
metadata_baseline<-metadata_baseline[-1]

otu_baseline_complete <- read.table(paste(project_location,"\\Output\\R\\OTUs\\",otu_name,sep=""),sep=",",header= TRUE)
rownames(otu_baseline_complete)<-otu_baseline_complete$X
otu_baseline_complete<-otu_baseline_complete[-1]

rownames(metadata_baseline)==rownames(otu_baseline_complete) #Should be true
```

#3. OTU Counts by sample
Read in OTU information, and determine total OTUs
```{r}
genus_found<-colnames(otu_baseline_complete)
samplelist_study<-rownames(otu_baseline_complete)

#For each sample, determine the total read counts
for (a in samplelist_study){
 #Set sum to 0
 sum=0
 
 #For each genus
 for (b in genus_found){
  
  #Add the number of counts together
  sum <- otu_baseline_complete[a,b] + sum
 }
 
 #When complete, push the sum to a new "Total_OTUs" row
 otu_baseline_complete[a,"Total_OTUs"] <- sum
}

write.csv(otu_baseline_complete,"test.csv")
```

#4. Relative Abundance  - Ext Controls
```{r}
relabun_baseline_study<-data.frame()

#Complete Relative Abundance
samplelist_study<-rownames(otu_baseline_complete)
genus_list <- colnames(otu_baseline_complete)
genus_list<-genus_list[-(length(genus_list))]
genus_list<-append(genus_list,rownames(control_expect))
kit_list <- unique(metadata_baseline$Ext.Kit)

for (a in kit_list){
 for (b in samplelist_study){
  for (c in genus_list){
   
   relabun <- otu_baseline_complete[b,c]
   
   if(!(is.na(relabun) || is.null(relabun) || relabun==0)){
    relabun_baseline_study[b,"Source.Descrip"]<-as.character(metadata_baseline[b,"Source.Descrip"])
    relabun_baseline_study[b,"Ext.Kit"]<-as.character(metadata_baseline[b,"Ext.Kit"])
    relabun_baseline_study[b,c] <- otu_baseline_complete[b,c]/otu_baseline_complete[b,"Total_OTUs"]
    relabun_baseline_study[b,"Homo.Method"] <- metadata_baseline[b,"Homo.Method"]
   }
  }
 }
}

relabun_baseline_study[is.na(relabun_baseline_study)]=0 #replace na's with 0
relabun_baseline_study[relabun_baseline_study=="A"]=0 #replace A's with 0
write.csv(relabun_baseline_study,paste(project_location,"\\Output\\R\\Data\\Baseline\\relabun_baseline_study.csv",sep=""))
```

#PCOA plots
```{r}
otu<-otu_table(physeq_filt_study)
tax<-tax_table(physeq_filt_study)
random_tree<-random_tree<-rtree(ntaxa(physeq_filt_study), rooted=TRUE, tip.label=taxa_names(physeq_filt_study))
sdata<- sample_data(metadata_baseline)
temp<-phyloseq(otu,tax,sdata,random_tree)

#######################
## Bray-Curtis
#######################
physeq_pcoa <- ordinate(
  physeq = temp, 
  method = "PCoA", 
  distance = "bray"
)
## Plot by Source.Descrip
p<- plot_ordination(
  physeq = temp,
  ordination = physeq_pcoa,
  color = "Source.Descrip",
  title = "PCoA of Source Descrip (Bray-Curtis)"
) + 
  scale_color_manual(values = c("#a65628", "red", "#ffae19",
    "#4daf4a", "#1919ff", "darkorchid3", "magenta")
  ) +
  geom_point(aes(color = Source.Descrip), alpha = 0.7, size = 6) +
  geom_point(colour = "grey90", size = 1.5)
file_name =(paste(project_location,"\\Output\\R\\Graphs\\Baseline\\bray_baseline_study_sourcedescrip.tiff"))
tiff(file_name, width=800)
print(p)
dev.off()

## Plot by Ext.Kit
p<- plot_ordination(
  physeq = temp,
  ordination = physeq_pcoa,
  color = "Ext.Kit",
  title = "PCoA of Ext.Kit (Bray-Curtis)"
) + 
  scale_color_manual(values = c("#a65628", "red", "#ffae19",
    "#4daf4a", "#1919ff", "darkorchid3", "magenta")
  ) +
  geom_point(aes(color = Ext.Kit), alpha = 0.7, size = 6) +
  geom_point(colour = "grey90", size = 1.5)
file_name =(paste(project_location,"\\Output\\R\\Data\\Baseline\\bray_baseline_study_extkit.tiff"))
tiff(file_name, width=800)
print(p)
dev.off()

## Plot by Homo.Method
p<- plot_ordination(
  physeq = temp,
  ordination = physeq_pcoa,
  color = "Homo.Method",
  title = "PCoA of Homo.Method (Bray-Curtis)"
) + 
  scale_color_manual(values = c("#a65628", "red", "#ffae19",
    "#4daf4a", "#1919ff", "darkorchid3", "magenta")
  ) +
  geom_point(aes(color = Homo.Method), alpha = 0.7, size = 6) +
  geom_point(colour = "grey90", size = 1.5)
file_name =(paste(project_location,"\\Output\\R\\Data\\Baseline\\bray_baseline_study_homomethod.tiff"))
tiff(file_name, width=800)
print(p)
dev.off()
```

#8 - Plot Interkit Sample Variability
```{r}
#Sort genus list alphabetically
genus_found<-sort(genus_found)

#Create list for plots, start counter
plot_list <- list()
i=1

#For each of the control types
for (a in control_types){
 
 #For each kit
 for (b in kit_types){
  
  #Create new dataframe and start counter
  temp<-data.frame()
  count=1
    
  ###Create list of sample ids with specific variables
  temp2 <- subset(samples_variables_f,Kit==b)
  temp2 <- subset(temp2,Type==a)
  sample_list <- unique(temp2$NephID)
  
  #For each sample in list
  for (c in sample_list){
   
   #For each genus
   for (d in genus_found){
    
    #Determine the abundance value
    value <- samples_obs_abund[d,c]
    aliquot<-samples_variables_f[c,"AliquotNumber"]
   
    #If the value is null or smaller than 1 X10-5, skip
    if(is.na(value) | is.null(value) | value<0.0000000001){
     next}
    
    #Otherwise add to datatable
    else{
     temp[count,"Abundance"]<-value
     temp[count,"Genus"]<-d
     
     if(aliquot=="None"){
      temp[count,"SampleID"]<-c
     }else{
      temp[count,"SampleID"]<-aliquot
     }
     count=count+1
     }
   }
  }
  
  #Create file name
  file_name <- paste ("Data/Study/SampleVari",b,a,sep = "_")
  file_name <- paste(file_name,".csv",sep="")
  
  #Sort and save the datatable
  temp<-temp[order(temp$SampleID), ]
  write.csv(temp,file_name)
  
  #Create graph title
  graph_title<-paste(a,b,sep="_")
    
  #Create Graph for the datatable
  graph_new<- ggplot(temp,aes(x =SampleID , y = Abundance, fill = Genus)) + 
   geom_bar(position = position_fill(), stat = "identity") +
   scale_y_continuous(labels = percent_format())+
   labs(title=graph_title, x="Sample ID", y= "Relative Abundance")+
   theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
   #+ theme(legend.position = "bottom",legend.box = "vertical")
   theme(legend.position = "none") ##Remove Legend
  
  graph_new  
  plot_list[[i]] = graph_new
  i=i+1
    
  #Reset data table
    temp<-data.frame()
  }
}

#Print the plots
i=1
for (a in control_types){
 
 for (b in kit_types){
  
  #Create file name
  file_name<-paste("Interkit Variability",a,b,sep="_")
  file_name<-paste("Data/Graphs/",file_name,".tiff",sep="")
  tiff(file_name)
  print(plot_list[[i]])
  dev.off()
  i=i+1
 }
}
```

#9 - Plot All Sample Variability in individual kit graphs
```{r}
#Create list for plots, start counter
plot_list <- list()
i=1

#For each of the control types
for (a in control_types){
 
 #Create new dataframe and start counter
 temp<-data.frame()
 count=1
    
 ###Create list of sample ids with specific variables
 temp2 <- subset(samples_variables_f,Type==a)
 sample_list <- unique(temp2$NephID)
 
 #For each sample in list
 for (b in sample_list){
  
  #For each genus
  for (c in genus_found){
   
   #Determine the abundance value
   value <- samples_obs_abund[c,b]
   aliquot<-samples_variables_f[b,"AliquotNumber"]
   
   #If the value is null or smaller than 1 X10-7, skip
   if(is.na(value) | is.null(value) | value<0.000000000001){
    next}
    
   #Otherwise add to datatable
   else{
    temp[count,"Abundance"]<-value
    temp[count,"Genus"]<-c
    
    if(aliquot=="None"){
     
     temp[count,"SampleID"]<-b
     }else{
      
      #Add kit info
      aliquot <- paste(aliquot,samples_variables_f[b,"Kit"],sep="_")
      temp[count,"SampleID"]<-aliquot
     }
    count=count+1
   }
  }
 }
 
 #Create file name
 file_name <- paste ("Data/Study/StudyVari",a,sep = "_")
 file_name <- paste(file_name,".csv",sep="")
 
 #Sort and save the datatable
 temp<-temp[order(temp$SampleID), ]
 write.csv(temp,file_name)
  
 #Create graph title
 graph_title<-paste(a,sep="_")
 
 #Create Graph for the datatable
 graph_new<- ggplot(temp,aes(x =SampleID , y = Abundance, fill = Genus)) + 
  geom_bar(position = position_fill(), stat = "identity") +
  scale_y_continuous(labels = percent_format())+
  labs(title=graph_title, x="Sample ID", y= "Relative Abundance")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  #+ theme(legend.position = "bottom",legend.box = "vertical")
  theme(legend.position = "none") ##Remove Legend
  
 plot_list[[i]] = graph_new
 i=i+1
    
 #Reset data table
   temp<-data.frame()
}

#Print the plots
i=1
for (a in control_types){
 
 #Create file name
 file_name<-paste("Interstudy Variability",a,sep="_")
 file_name<-paste("Data/Graphs/",file_name,".tiff",sep="")
 tiff(file_name)
 print(plot_list[[i]])
 dev.off()
 i=i+1
}
```

#9 - Plot All Sample Variability in individual kit graphs
```{r}
#Create list for plots, start counter
plot_list <- list()
i=1

#Create new dataframe and start counter
temp<-data.frame()
count=1
    
for (a in kit_types){
 ###Create list of sample ids with specific variables
 temp2 <- subset(samples_variables_f,Type=="Study" & Kit==a)
 sample_list <- unique(temp2$NephID)
 
 for (b in sample_list){
  
  for (c in genus_found){
   temp[count,"Value"]<-samples_obs_abund[c,b]
   temp[count,"Kit"]<-a
   temp[count,"Aliquot"]<-samples_variables_f[b,"AliquotNumber"]
   temp[count,"SampleID"]<- paste(a,samples_variables_f[b,"AliquotNumber"],sep="_")
   temp[count,"ID"]<-b
   temp[count,"Genus"]<-c
   count=count+1
  }
 }
}
write.csv(temp,"temp4.csv")
#Remove DSP kit samples


temp<-read.csv("temp4.csv",header = TRUE)

#Create Graph for the datatable
graph_title <- "Fecal Samples by Kit by Aliquot ID"
graph_new<- ggplot(temp,aes(x =SampleID , y = Value, fill = Genus)) + 
  geom_bar(position = position_fill(), stat = "identity") +
  scale_y_continuous(labels = percent_format())+
  labs(title=graph_title, x="Sample ID", y= "Relative Abundance")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  #+ theme(legend.position = "bottom",legend.box = "vertical")
  theme(legend.position = "none") ##Remove Legend
  
plot_list[[i]] = graph_new
 
#Print the plot
file_name <- "StudyVariability"
file_name<-paste("Data/Graphs/",file_name,".tiff",sep="")
tiff(file_name)
print(plot_list[[i]])
dev.off()

```



#10 - Plot all sample variability in one graph
```{r}
#Edit the data to be able to numerically order the aliquots
temp<-read.csv("Data/Study/StudyVari_Study_Edited(Aliquot).csv",header = TRUE)

#Edit the data to be able to numerically order the aliquots by kit
temp<-read.csv("Data/Study/StudyVari_Study_Edited(Kit).csv",header = TRUE)
temp$X<- factor(temp$X, levels=temp$X)

#Create a plot for 
ggplot(temp,aes(x =SampleID , y = Abundance, fill = Genus)) + 
 geom_bar(position = position_fill(), stat = "identity") +
 scale_y_continuous(labels = percent_format())+
 labs(title="Fresh-Frozen Fecal Study Samples", x="Extraction Kit_Aliquot ID", y= "Relative Abundance")+
 theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
 #+ theme(legend.position = "bottom",legend.box = "vertical")
 theme(legend.position = "none") ##Remove Legend

```